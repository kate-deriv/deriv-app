import React from 'react';
import { TransitionGroup, CSSTransition } from 'react-transition-group';
import { Icon, Div100vhContainer, Modal, Text } from '@deriv/components';
import { routes } from '@deriv/shared';
import { localize } from '@deriv/translations';
import { NavLink } from 'react-router-dom';
import EmptyPortfolioMessage from '../EmptyPortfolioMessage';
import PositionsModalCard from 'App/Components/Elements/PositionsDrawer/positions-modal-card.jsx';
import { filterByContractType } from 'App/Components/Elements/PositionsDrawer/helpers';
import TogglePositions from './toggle-positions';
import { useTraderStore } from 'Stores/useTraderStores';
import { observer, useStore } from '@deriv/stores';

type TTogglePositionsMobile = Pick<
    ReturnType<typeof useStore>['portfolio'],
    'active_positions_count' | 'all_positions' | 'error' | 'onClickSell' | 'onClickCancel'
> & {
    currency: ReturnType<typeof useStore>['client']['currency'];
    is_empty: number;
};

const TogglePositionsMobile = observer(
    ({
        active_positions_count,
        all_positions,
        currency,
        error,
        is_empty,
        onClickSell,
        onClickCancel,
    }: TTogglePositionsMobile) => {
        const { portfolio, ui } = useStore();
        const { symbol, contract_type: trade_contract_type } = useTraderStore();
        const { removePositionById: onClickRemove } = portfolio;
        const { togglePositionsDrawer, toggleUnsupportedContractModal, is_positions_drawer_on } = ui;
        let filtered_positions: TTogglePositionsMobile['all_positions'] = [];

        const closeModal = () => {
            filtered_positions.slice(0, 5).map(position => {
                const { contract_info } = position;
                if (contract_info?.is_sold) {
                    onClickRemove(contract_info.contract_id as number);
                }
            });
            togglePositionsDrawer();
        };

        filtered_positions = all_positions.filter(
            p =>
                p.contract_info &&
                symbol === p.contract_info.underlying &&
                //@ts-expect-error filterByContractType function needs to be in typescript
                filterByContractType(p.contract_info, trade_contract_type)
        );

        // Show only 5 most recent open contracts
        const body_content = (
            <React.Fragment>
                <TransitionGroup component='div'>
                    {filtered_positions.slice(0, 5).map(portfolio_position => (
                        <CSSTransition
                            appear
                            key={portfolio_position.id}
                            in={true}
                            timeout={150}
                            classNames={{
                                appear: 'dc-contract-card__wrapper--enter',
                                enter: 'dc-contract-card__wrapper--enter',
                                enterDone: 'dc-contract-card__wrapper--enter-done',
                                exit: 'dc-contract-card__wrapper--exit',
                            }}
                            unmountOnExit
                        >
                            <PositionsModalCard
                                // @ts-expect-error observer wrapped component needs to be ts migrated for props to be detected
                                onClickSell={onClickSell}
                                onClickCancel={onClickCancel}
                                onClickRemove={onClickRemove}
                                key={portfolio_position.id}
                                currency={currency}
                                toggleUnsupportedContractModal={toggleUnsupportedContractModal}
                                togglePositions={togglePositionsDrawer}
                                {...portfolio_position}
                            />
                        </CSSTransition>
                    ))}
                </TransitionGroup>
            </React.Fragment>
        );

        return (
            <React.Fragment>
                <TogglePositions
                    is_open={is_positions_drawer_on}
                    togglePositions={togglePositionsDrawer}
                    positions_count={active_positions_count}
                />
                <Modal
                    is_open={is_positions_drawer_on}
                    toggleModal={closeModal}
                    id='dt_mobile_positions'
                    is_vertical_top
                    has_close_icon
                    width='calc(100vw - 32px)'
                >
                    <Div100vhContainer className='positions-modal' height_offset='48px'>
                        <div className='positions-modal__header'>
                            <Text size='xxxs' className='positions-modal__title'>
                                <Icon icon='IcPortfolio' className='positions-modal__title-icon' />
                                {localize('Recent positions')}
                            </Text>
                            <div className='positions-modal__close-btn' onClick={closeModal}>
                                <Icon icon='IcMinusBold' />
                            </div>
                        </div>
                        <div className='positions-modal__body'>
                            {is_empty || error ? <EmptyPortfolioMessage error={error} /> : body_content}
                        </div>
                        <div className='positions-modal__footer'>
                            <NavLink
                                onClick={closeModal}
                                className='dc-btn dc-btn--secondary dc-btn__large positions-modal__footer-btn'
                                to={routes.positions}
                            >
                                <Text size='xs' weight='bold'>
                                    {localize('Go to Reports')}
                                </Text>
                            </NavLink>
                        </div>
                    </Div100vhContainer>
                </Modal>
            </React.Fragment>
        );
    }
);

export default TogglePositionsMobile;
